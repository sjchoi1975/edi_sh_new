# 신일 PMS 개발 기획 최종 요약 문서 (v3.0)

**문서 버전: 3.0 (2025-07-22)**

## 폴더 구조
- `/vue-project` : 프론트엔드 소스 (Vue.js)
- `/sql-scripts` : DB 관련 SQL 스크립트
- `/admin-scripts` : 관리자용 Node.js 스크립트

## 개발 환경 및 실행 방법
1. Node.js 18+ 권장
2. 터미널에서 아래 명령 실행
   ```bash
   cd vue-project
   npm install
   npm run dev
   ```
3. 브라우저에서 [http://localhost:5173](http://localhost:5173) 접속

## 빌드 및 배포
- 빌드: `npm run build` (결과물은 `dist/` 폴더)
- Vercel 자동 배포 (Root: vue-project, Output: dist)
- SPA 라우팅: `vercel.json`에 rewrites 설정 필수

## 환경변수
- `vue-project/.env.local`에 Supabase 등 민감 정보 저장

## 1. 개요 및 설계 철학

### 1.1. 문서의 목적

본 문서는 신일 PMS(성과 관리 시스템)의 **아키텍처, 핵심 기능, 데이터 구조, 그리고 주요 로직을 종합적으로 정리**한 공식 개발 기획 문서입니다. 시스템의 안정적인 유지보수, 신규 개발자의 온보딩, 그리고 향후 기능 확장을 위한 핵심 가이드라인으로 활용하는 것을 최우선 목적으로 합니다.

### 1.2. 시스템 설계 철학

본 시스템은 다음 세 가지 핵심 철학을 바탕으로 설계되었습니다.

1.  **데이터 무결성 (Data Integrity):** 사용자가 입력한 원본 데이터는 절대 변경되지 않습니다. 모든 수정 및 변경 사항은 별도의 테이블(`performance_records_absorption`)에 이력으로 기록되어, 데이터의 정합성을 보장하고 모든 변경 과정을 추적할 수 있습니다.
2.  **로직의 중앙화 (Centralized Logic):** 복잡한 데이터 처리, 집계, 계산 로직은 최대한 프론트엔드에서 분리하여 데이터베이스의 **뷰(View)와 함수(RPC)에 중앙화**합니다. 이를 통해 프론트엔드는 UI 표시에만 집중할 수 있어 코드의 복잡성이 감소하고 유지보수성이 향상됩니다.
3.  **상태 기반 UI (State-Driven UI):** 모든 데이터와 UI 컴포넌트는 명확한 '상태'(`status`, `action` 등)를 가집니다. 이 상태 값에 따라 UI가 동적으로 변화하여, 사용자에게 현재 진행 상황을 명확하게 인지시키고 오작동을 방지합니다.

---

## 2. 핵심 데이터 흐름 (Data Flow Lifecycle)

하나의 실적 데이터가 생성되어 최종 정산되기까지의 여정은 다음과 같습니다.

1.  **`[생성]` 사용자가 실적 입력**:
    -   사용자가 UI를 통해 실적 정보를 입력하고 저장합니다.
    -   데이터는 `performance_records` 테이블에 저장됩니다.
    -   이때, `review_status`는 **'대기'** 상태가 됩니다.

2.  **`[동기화]` 관리자가 검수 시작**:
    -   관리자가 '실적 검수' 화면에서 '불러오기'를 실행합니다.
    -   `performance_records`의 '대기' 상태 데이터를 '검수중'으로 변경합니다.
    -   동시에 `performance_records_absorption` 테이블에 복사하여 검수 작업을 진행합니다.

3.  **`[변경]` 관리자가 검수 진행**:
    -   관리자는 `performance_records_absorption`의 데이터를 기반으로 수정, 추가, 삭제 작업을 수행합니다.
    -   **수정**: `..._modify` 필드에 변경 값이 저장되고, `review_action`은 '수정'이 됩니다.
    -   **추가**: `..._add` 필드에 업체/거래처 정보가 저장되고, `review_action`은 '추가'가 됩니다.
    -   **삭제**: `review_action`이 '삭제'로 업데이트됩니다. (실제 행 삭제 X)

4.  **`[확정]` 관리자가 검수 완료**:
    -   관리자가 '검수 상태 변경' 버튼을 통해 검수를 마칩니다.
    -   `performance_records_absorption`의 `review_status`와 원본 `performance_records`의 `review_status`가 모두 **'완료'**로 변경됩니다.

5.  **`[활용]` 데이터 분석 및 공유**:
    -   `review_status`가 '완료'된 데이터만이 '흡수율 분석'과 '정산내역서 공유' 화면에 집계될 자격을 얻습니다.
    -   모든 데이터 조회는 복잡한 테이블들을 미리 결합해놓은 `review_details_view`를 통해 이루어집니다.

---

## 3. 주요 기능 및 사용자 시나리오

### 3.1. 실적 검수 (`AdminPerformanceReviewView.vue`)

-   **기능 목표**: 관리자가 사용자의 실적을 효율적으로 검토하고, 오류를 수정하며, 최종 데이터를 확정하는 인터페이스를 제공합니다.
-   **사용자 시나리오**:
    1.  관리자는 '정산월'을 선택하고 '실적 정보 불러오기' 버튼을 클릭합니다.
    2.  시스템은 '대기' 상태의 모든 실적을 화면에 로드하고 '검수중' 상태로 전환합니다.
    3.  관리자는 각 행을 검토하며, 특정 행의 '수정(✎)' 버튼을 눌러 인라인 편집 모드로 전환합니다. 수량, 수수료율 등을 변경하고 '저장(✓)' 버튼을 누릅니다.
    4.  특정 행 아래에 새로운 실적을 추가하고 싶으면, '+' 버튼을 눌러 새 행을 만들고 정보를 입력 후 저장합니다.
    5.  검수를 마친 행들을 체크박스로 선택한 후, '검수 상태 변경' 버튼을 눌러 '완료' 상태로 확정합니다.

### 3.2. 흡수율 분석 (`AdminAbsorptionAnalysisView.vue`)

-   **기능 목표**: 검수가 완료된 데이터를 기반으로, 제품별 처방액 대비 실제 매출(흡수율)을 분석하여 영업 성과를 다각도로 평가합니다.
-   **사용자 시나리오**:
    1.  관리자는 '정산월', '업체', '병의원' 등 원하는 필터 조건을 설정합니다.
    2.  '검수 완료 불러오기'를 클릭하여 조건에 맞는 '완료' 상태의 실적 데이터를 조회합니다.
    3.  '흡수율 분석' 버튼을 클릭하면, 시스템은 백그라운드(DB 함수)에서 각 실적의 도매/직거래 매출을 합산하고 처방액과 비교하여 흡수율(%)을 계산한 후, 테이블의 '합산액' 및 '흡수율' 열을 업데이트합니다.

### 3.3. 정산내역서 공유 (`AdminSettlementShareView.vue`)

-   **기능 목표**: 최종 확정된 실적을 **업체별로 깔끔하게 합산**하여 보여주고, 각 업체 담당자가 자신의 정산 내역을 조회할 수 있도록 공유 상태를 제어합니다.
-   **사용자 시나리오**:
    1.  관리자는 '정산월'을 선택합니다.
    2.  시스템은 해당 월의 '완료'된 모든 실적을 업체별로 자동 합산하여, 업체당 한 줄의 요약 데이터를 보여줍니다. (총 처방액, 총 지급액 등)
    3.  관리자는 각 업체의 '공유' 체크박스를 선택/해제하고 '저장' 버튼을 눌러 공유 상태를 업데이트합니다.
    4.  공유가 활성화된 업체의 담당자는 자신의 계정으로 로그인하여 해당 월의 정산 내역을 조회할 수 있게 됩니다.

---

## 4. 최신 테이블 구조 개요

### 4.1. 핵심 테이블
- **`performance_records`**: 사용자 실적 원본 데이터 (review_status: '대기', '검수중', '완료')
- **`performance_records_absorption`**: 관리자 검수 및 분석용 테이블
- **`companies`**: 업체 정보 (user_type: 'admin', 'user')
- **`clients`**: 거래처(병의원) 정보
- **`products`**: 제품 정보 (commission_rate_a, commission_rate_b, commission_rate_c)
- **`pharmacies`**: 약국 정보
- **`wholesale_sales`**: 도매 매출 데이터
- **`direct_sales`**: 직거래 매출 데이터
- **`settlement_months`**: 정산월 관리
- **`settlement_share`**: 정산내역서 공유 설정
- **`notices`**: 공지사항 (is_pinned, view_count)
- **`performance_evidence_files`**: 실적 증빙 파일

### 4.2. 매핑 테이블
- **`client_company_assignments`**: 거래처-업체 매핑 (commission_grade)
- **`client_pharmacy_assignments`**: 거래처-약국 매핑

---

## 5. Database Functions 개요

### 5.1. 핵심 비즈니스 로직 함수들
- **`calculate_absorption_rates`**: 흡수율 분석 실행 (도매/직거래 매출액 계산)
- **`get_settlement_summary_by_company`**: 정산내역서 공유용 업체별 합산 데이터 조회
- **`create_settlement_summary`**: 정산월별 요약 데이터 생성

### 5.2. 변경사항 감지 함수들
- **`check_for_updates`**: 정산월별 변경사항 확인 (검수, 매핑, 매출 데이터 변경)
- **`check_performance_changes`**: 실적 데이터 변경사항 확인 (추가, 수정, 삭제 건수)

### 5.3. 데이터 조회 함수들
- **`get_absorption_analysis_details`**: 흡수율 분석 화면의 상세 데이터 조회
- **`get_distinct_companies_from_analysis`**: 업체 필터 목록 조회
- **`get_distinct_clients_from_analysis`**: 거래처 필터 목록 조회
- **`get_distinct_settlement_months_from_analysis`**: 정산월 필터 목록 조회

### 5.4. 디버깅 함수들
- **`debug_absorption_calculation`**: 흡수율 계산 디버깅용
- **`debug_absorption_rates`**: 흡수율 분석 디버깅용 (상세 매칭 정보)
- **`debug_distribution_ratios`**: 분배 비율 디버깅용

### 5.5. Edge Functions
- **`register-user`**: 사용자 회원가입 처리
- **`reset-password`**: 비밀번호 초기화

---

## 6. 향후 개선 과제 및 고려사항

-   **권한 관리 고도화**: 현재는 'admin'과 'user' 역할만 존재하지만, 향후 특정 업체 담당자가 여러 업체를 관리하거나, 특정 메뉴에만 접근하는 등의 세분화된 권한 관리가 필요할 수 있습니다.
-   **대시보드 기능**: 현재는 테이블 형태의 데이터 조회가 중심이지만, 주요 지표(월별 총 지급액, 상위 5개 업체 등)를 시각적인 차트와 그래프로 보여주는 대시보드 기능을 추가하여 사용성을 개선할 수 있습니다.
-   **성능 최적화**: 데이터가 수십만 건 이상으로 증가할 경우, 현재의 View와 함수(RPC)의 성능을 모니터링하고 인덱스(Index) 추가, 쿼리 최적화 등의 작업이 필요할 수 있습니다.
-   **사용자 경험(UX) 개선**: 엑셀 업로드/다운로드 기능의 편의성을 개선하고, 각 입력 필드에 대한 유효성 검사(Validation)를 강화하여 사용자 실수를 줄이는 방안을 고려해야 합니다. 