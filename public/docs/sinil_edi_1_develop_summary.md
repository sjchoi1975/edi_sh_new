# 신일제약 실적관리 시스템 개발 요약 문서 (v3.3)

## 📋 문서 정보

### 📄 파일명과 주요 내용
- **파일명**: `sinil_edi_1_develop_summary.md`
- **주요 내용**: 시스템 개요 및 설계 철학, 개발 환경 및 기술 스택, 시스템 아키텍처, 핵심 데이터 흐름, 향후 개선 과제
- **문서 성격**: 개발 요약 문서로 개요 내용 포함

### 🔄 문서구조 논리적 흐름
1. **개요 (개발 요약)** → 2. **주요 기능 (메뉴/화면별 기능)** → 3. **데이터 구조 (테이블/관계/RLS)** → 4. **주요 로직 (구현 방식/알고리즘)**

### 🔗 상호 참조관계
- **개요** → 주요 기능, 데이터 구조, 주요 로직 참조
- **주요 기능** → 데이터 구조, 주요 로직 참조  
- **데이터 구조** → 주요 기능, 주요 로직 참조
- **주요 로직** → 주요 기능, 데이터 구조 참조

---

**문서 버전: 3.4 (2025-01-07)**

## 1. 개요 및 설계 철학

### 1.1. 문서의 목적

본 문서는 신일제약 실적관리 시스템의 **아키텍처, 핵심 기능, 데이터 구조, 그리고 주요 로직을 종합적으로 정리**한 공식 개발 기획 문서입니다. 시스템의 안정적인 유지보수, 신규 개발자의 온보딩, 그리고 향후 기능 확장을 위한 핵심 가이드라인으로 활용하는 것을 최우선 목적으로 합니다.

### 1.2. 시스템 설계 철학

본 시스템은 다음 세 가지 핵심 철학을 바탕으로 설계되었습니다.

1.  **데이터 무결성 (Data Integrity):** 사용자가 입력한 원본 데이터는 절대 변경되지 않습니다. 모든 수정 및 변경 사항은 별도의 테이블(`performance_records_absorption`)에 이력으로 기록되어, 데이터의 정합성을 보장하고 모든 변경 과정을 추적할 수 있습니다.
2.  **로직의 중앙화 (Centralized Logic):** 복잡한 데이터 처리, 집계, 계산 로직은 최대한 프론트엔드에서 분리하여 데이터베이스의 **뷰(View)와 함수(RPC)에 중앙화**합니다. 이를 통해 프론트엔드는 UI 표시에만 집중할 수 있어 코드의 복잡성이 감소하고 유지보수성이 향상됩니다.
3.  **상태 기반 UI (State-Driven UI):** 모든 데이터와 UI 컴포넌트는 명확한 '상태'(`status`, `action` 등)를 가집니다. 이 상태 값에 따라 UI가 동적으로 변화하여, 사용자에게 현재 진행 상황을 명확하게 인지시키고 오작동을 방지합니다.

### 1.3. 개발 환경 및 기술 스택

#### 1.3.1. 프론트엔드 (Frontend)
- **프레임워크**: Vue.js 3.5.13 (Composition API)
- **UI 라이브러리**: PrimeVue 4.2.0 (Aura 테마)
- **빌드 도구**: Vite 6.2.4
- **패키지 관리**: npm
- **라우팅**: Vue Router 4.5.0
- **상태 관리**: Vue 3 Composition API (Pinia 미사용)
- **HTTP 클라이언트**: Supabase JavaScript Client 2.49.4
- **추가 라이브러리**: 
  - XLSX 0.18.5 (엑셀 처리)
  - File-saver 2.0.5 (파일 다운로드)
  - JSZip 3.10.1 (압축 파일 처리)
  - html2canvas 1.4.1 (화면 캡처)
  - jsPDF 3.0.1 (PDF 생성)
  - CKEditor 5.41.4.2 (리치 텍스트 에디터)
  - Quill 2.0.3 (텍스트 에디터)
  - VueDraggable 4.1.0 (드래그 앤 드롭)

#### 1.3.2. 백엔드 (Backend)
- **BaaS 플랫폼**: Supabase
- **데이터베이스**: PostgreSQL 15.x
- **인증**: Supabase Auth (Email/Password)
- **파일 저장소**: Supabase Storage
- **실시간 기능**: Supabase Realtime
- **Edge Functions**: Deno (TypeScript)

#### 1.3.3. 개발 도구
- **IDE**: Visual Studio Code
- **버전 관리**: Git
- **코드 품질**: ESLint 9.22.0
- **코드 포맷팅**: Prettier 3.5.3
- **형식 검사**: TypeScript (선택적)
- **API 테스트**: Supabase Dashboard
- **Vue 개발 도구**: Vite Plugin Vue DevTools 7.7.2

#### 1.3.4. 배포 환경
- **프론트엔드 배포**: Vercel
- **백엔드 서비스**: Supabase Cloud
- **도메인**: 사용자 정의 도메인 (선택적)
- **SSL 인증서**: 자동 (Vercel/Supabase 제공)

### 1.4. 시스템 아키텍처

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Vue.js 3.x    │    │   PrimeVue      │    │   Vite Build    │
│   Frontend      │◄──►│   UI Components │◄──►│   Tool          │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                                              │
         │ HTTP/WebSocket                               │
         ▼                                              ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Supabase      │    │   PostgreSQL    │    │   Supabase      │
│   Auth + RLS    │◄──►│   Database      │◄──►│   Storage       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                                              │
         │ Edge Functions                               │
         ▼                                              ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Deno          │    │   Vercel        │    │   Custom        │
│   Functions     │    │   Deployment    │    │   Domain        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.5. 개발 환경 설정

#### 1.5.1. 필수 요구사항
- **Node.js**: 18.x 이상 (Vite 6.x 요구사항)
- **npm**: 9.x 이상
- **Git**: 2.x 이상
- **브라우저**: Chrome, Firefox, Safari, Edge (최신 버전)
- **메모리**: 최소 4GB RAM (대용량 엑셀 파일 처리 시)

#### 1.5.2. 환경 변수 설정
```bash
# .env.local
VITE_SUPABASE_URL=your_supabase_project_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
VITE_APP_TITLE=신일제약 실적관리 시스템
VITE_APP_VERSION=3.0.0
```

#### 1.5.3. 개발 서버 실행
```bash
# 의존성 설치
npm install

# 개발 서버 실행
npm run dev

# 프로덕션 빌드
npm run build

# 빌드 미리보기
npm run preview

# 코드 린팅
npm run lint

# 코드 포맷팅
npm run format
```

### 1.6. 데이터베이스 설계 원칙

#### 1.6.1. 테이블 명명 규칙
- **일반 테이블**: `snake_case` (예: `performance_records`)
- **매핑 테이블**: `entity_entity_assignments` (예: `client_company_assignments`)
- **뷰**: `entity_details_view` (예: `review_details_view`)
- **함수**: `action_entity` (예: `calculate_absorption_rates`)

#### 1.6.2. 컬럼 명명 규칙
- **기본 컬럼**: `snake_case` (예: `created_at`, `updated_at`)
- **상태 컬럼**: `status` (예: `review_status`, `user_status`)
- **액션 컬럼**: `action` (예: `review_action`)
- **수정 컬럼**: `field_modify` (예: `prescription_qty_modify`)
- **추가 컬럼**: `field_add` (예: `company_name_add`)

#### 1.6.3. 인덱스 전략
- **기본키**: 모든 테이블에 `id` (UUID) 기본키
- **외래키**: 참조 무결성을 위한 인덱스
- **조회 최적화**: `review_status`, `settlement_month` 등 자주 조회되는 컬럼
- **복합 인덱스**: `(settlement_month, company_id, review_status)` 등

---

## 2. 핵심 데이터 흐름 (Data Flow Lifecycle)

하나의 실적 데이터가 생성되어 최종 정산되기까지의 여정은 다음과 같습니다.

### 2.1. 실적 데이터 처리 플로우

1.  **`[생성]` 사용자가 실적 입력**:
    -   사용자가 UI를 통해 실적 정보를 입력하고 저장합니다.
    -   데이터는 `performance_records` 테이블에 저장됩니다.
    -   이때, `review_status`는 **'대기'** 상태가 됩니다.

2.  **`[동기화]` 관리자가 검수 시작**:
    -   관리자가 '실적 검수' 화면에서 '불러오기'를 실행합니다.
    -   `performance_records`의 '대기' 상태 데이터를 '검수중'으로 변경합니다.
    -   동시에 `performance_records_absorption` 테이블에 복사하여 검수 작업을 진행합니다.

3.  **`[변경]` 관리자가 검수 진행**:
    -   관리자는 `performance_records_absorption`의 데이터를 기반으로 수정, 추가, 삭제 작업을 수행합니다.
    -   **수정**: `..._modify` 필드에 변경 값이 저장되고, `review_action`은 '수정'이 되며, `review_status`는 **'완료'**로 자동 변경됩니다.
    -   **추가**: `..._add` 필드에 업체/거래처 정보가 저장되고, `review_action`은 '추가'가 되며, `review_status`는 **'완료'**로 자동 변경됩니다.
    -   **삭제**: `review_action`이 '삭제'로 업데이트되고, `review_status`는 **'완료'**로 자동 변경됩니다. (실제 행 삭제 X)

4.  **`[확정]` 관리자가 검수 완료**:
    -   관리자가 '검수 상태 변경' 버튼을 통해 검수를 마칩니다.
    -   `performance_records_absorption`의 `review_status`와 원본 `performance_records`의 `review_status`가 모두 **'완료'**로 변경됩니다.

5.  **`[활용]` 데이터 분석 및 공유**:
    -   `review_status`가 '완료'된 데이터만이 '흡수율 분석'과 '정산내역서 공유' 화면에 집계될 자격을 얻습니다.
    -   **삭제된 건 처리**: `review_action`이 '삭제'인 건은 흡수율 분석, 정산내역서에서 처방액과 지급액을 0으로 표시합니다.
    -   **흡수율 분석 시간 관리**: 흡수율 분석 실행 시 `analysis_time` 컬럼에 분석 시간을 기록하여 재분석 필요성 체크의 기준으로 사용합니다.
    -   모든 데이터 조회는 복잡한 테이블들을 미리 결합해놓은 `review_details_view`를 통해 이루어집니다.

### 2.2. 수수료율 산정 플로우

시스템의 수수료율은 계층적 구조로 관리되며, 다음과 같은 우선순위로 적용됩니다:

**데이터베이스 구조**:
- `companies.default_commission_grade`: 업체별 기본 등급 (A~E)
- `client_company_assignments.modified_commission_grade`: 병의원별 개별 등급 (우선 적용)
- `products.commission_rate_a~e`: 제품별 등급별 수수료율

**적용 우선순위**:
1. **병의원별 개별 등급** (`modified_commission_grade`) - 최우선
2. **업체 기본 등급** (`company_default_commission_grade`) - 기본값
3. **검수 시 수정** (`commission_rate_modify`) - 관리자 재조정

**자동 동기화**: 업체 등급 변경 시 관련 병의원들의 기본 등급이 자동으로 동기화됩니다.

> **📋 상세 내용**: 수수료율 관리의 상세 구조와 구현 로직은 `sinil_edi_3_data_structure.md`의 "수수료율 관리 테이블" 섹션과 `sinil_edi_4_main_logic.md`의 "수수료율 계산 로직" 섹션을 참조하세요.

### 2.3. 제품 노출 관리 플로우

제품의 노출은 이중 구조로 관리되어 세밀한 제어가 가능합니다:

**관리 구조**:
- **제품 상태**: `products.status` ('active'/'inactive') - 전체 시스템 기준
- **업체별 활성화**: `product_company_assignments.is_active` - 업체별 개별 설정

**데이터 접근**:
- **관리자**: `admin_products_with_company_status` 뷰로 전체 제품 + 업체별 상태 조회
- **사용자**: `user_products` 뷰로 자신의 업체에 활성화된 제품만 조회

**보험코드 기반 매핑**: 동일한 보험코드의 제품들이 업체별로 일괄 관리됩니다.

> **📋 상세 내용**: 제품 노출 관리의 상세 구조와 구현 로직은 `sinil_edi_3_data_structure.md`의 "제품-업체 매핑 테이블" 섹션과 `sinil_edi_4_main_logic.md`의 "제품 노출 관리 로직" 섹션을 참조하세요.

---

## 3. 시스템 구성 개요

### 3.1. 사용자 권한 체계
- **관리자 (admin)**: 신일제약 담당자 - 모든 기능 접근 가능
- **일반 사용자 (user)**: CSO 업체 담당자 - 자신의 업체 데이터만 접근

### 3.2. 주요 기능 영역
1. **실적 관리**: 실적 등록, 조회, 수정, 검수
2. **정산 관리**: 흡수율 분석, 정산내역서 공유
3. **마스터 관리**: 업체, 거래처, 제품, 약국 정보 관리
4. **시스템 관리**: 공지사항, 정산월, 사용자 설정 관리
5. **수수료 관리**: 업체별 기본 등급 설정, 병의원별 등급 조정
6. **제품 노출 관리**: 업체별 제품 활성/비활성 설정

### 3.3. 핵심 테이블 개요
- **`performance_records`**: 사용자 실적 원본 데이터
- **`performance_records_absorption`**: 관리자 검수 및 분석용 테이블
- **`companies`**: 업체 정보 (권한 관리, 기본 수수료 등급 포함)
- **`clients`**: 거래처(병의원) 정보
- **`products`**: 제품 정보 (A~E등급 수수료율 포함)
- **`settlement_months`**: 정산월 관리 (실적입력기간 제어)
- **`client_company_assignments`**: 업체-거래처 매핑 (개별 수수료 등급 조정)
- **`product_company_assignments`**: 제품-업체 매핑 (업체별 제품 활성/비활성 설정)

### 3.4. 보안 및 권한 관리
- **Row Level Security (RLS)**: Supabase RLS를 활용한 데이터 접근 제어
- **업체별 데이터 격리**: 일반 사용자는 자신의 업체 데이터만 접근
- **관리자 전체 접근**: 관리자는 모든 데이터에 대한 전체 권한 보유
- **JWT 토큰 기반 인증**: Supabase Auth를 통한 안전한 인증

---

## 4. 문서 구성 안내

본 시스템의 상세 내용은 다음 문서들에서 확인할 수 있습니다:

1. **`sinil_edi_2_main_features.md`**: 주요 기능 상세 (메뉴 구조, 화면별 기능)
2. **`sinil_edi_3_data_structure.md`**: 데이터 구조 상세 (테이블 정의, 관계, RLS 정책)
3. **`sinil_edi_4_main_logic.md`**: 주요 로직 상세 (핵심 기능 구현 로직)

각 문서는 상호 연관성을 고려하여 작성되었으며, 중복을 최소화하고 참조 관계를 명확히 표시했습니다.

---

## 5. 향후 개선 과제 및 고려사항

### 5.1. 기능 확장 및 개선
-   **대시보드 기능**: 주요 지표를 시각적인 차트와 그래프로 표시
-   **실시간 알림 시스템**: 중요 이벤트에 대한 실시간 알림
-   **모바일 앱 개발**: 웹 기반 시스템을 모바일 앱으로 확장
-   **파일 관리 시스템**: 실적 증빙 파일의 체계적인 관리 및 검색 기능 강화
-   **공지사항 고도화**: 파일 첨부, 외부 링크, 조회수 추적 등 고급 기능 추가
-   **수수료율 관리 고도화**: 수수료율 변경 이력 추적, 일괄 변경 기능, 수수료율 분석 리포트
-   **제품 노출 관리 개선**: 제품별 노출 통계, 자동 활성화 규칙, 제품 추천 시스템
-   **흡수율 재분석 자동화**: 데이터 변경 시 자동으로 재분석 필요성 체크 및 알림
-   **삭제된 건 관리 개선**: 삭제된 건의 복원 기능 및 이력 추적 강화

### 5.2. 성능 최적화
-   **성능 최적화**: 대용량 데이터 처리 시 View와 함수(RPC)의 성능 모니터링
-   **캐싱 전략**: Redis 등을 활용한 데이터 캐싱 시스템 도입
-   **CDN 도입**: 정적 파일에 대한 CDN 도입으로 로딩 속도 개선

### 5.3. 사용자 경험 개선
-   **사용자 경험(UX) 개선**: 엑셀 업로드/다운로드 기능의 편의성 개선
-   **접근성 개선**: 스크린 리더 지원, 키보드 네비게이션 강화
-   **다국어 지원**: 향후 해외 진출을 고려한 다국어 지원 시스템

### 5.4. 보안 강화
-   **2단계 인증**: SMS, 이메일, OTP 앱 등을 활용한 2단계 인증 시스템
-   **감사 로그**: 모든 데이터 변경 사항에 대한 상세한 감사 로그 기록
-   **데이터 암호화**: 민감한 데이터에 대한 암호화 강화

### 5.5. 시스템 확장성
-   **마이크로서비스 아키텍처**: 모놀리식 구조를 마이크로서비스로 분리
-   **컨테이너화**: Docker를 활용한 컨테이너화로 배포 및 운영 효율성 향상
-   **자동화**: CI/CD 파이프라인 구축으로 개발 및 배포 프로세스 자동화

### 5.6. 데이터 분석 및 인사이트
-   **BI 도구 연동**: Tableau, Power BI 등과 연동하여 고급 데이터 분석 기능 제공
-   **머신러닝**: 실적 예측, 이상 패턴 감지 등 머신러닝 기능 도입
-   **API 확장**: 외부 시스템과의 연동을 위한 RESTful API 확장 